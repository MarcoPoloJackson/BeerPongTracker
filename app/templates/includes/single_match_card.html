{# FILE: templates/includes/single_match_card.html #}

{% set badge_text = 'IN PREPARAZIONE' %}
{% set status_class = 'prep' %}

{% if 'redemption' in m.status %}
    {% set badge_text = 'üî• SALVEZZA' %}
    {% set status_class = 'redemption' %}
{% elif m.mode == 'overtime' %}
    {% set badge_text = '‚ö° OVERTIME' %}
    {% set status_class = 'overtime' %}
{% elif m.t1_p1 and m.t2_p1 %}
     {% set badge_text = 'üü¢ LIVE' %}
     {% set status_class = 'live' %}
{% endif %}

<div id="table-card-{{ m.id }}" class="match-card fade-in {{ status_class }}">
    <div class="match-header">
        <span class="match-title">Tavolo #{{ m.id }}</span>
        <span class="status-badge {{ status_class }}">{{ badge_text }}</span>
        <a href="{{ url_for('main.manual_override', match_id=m.id) }}" class="btn-manual-mini" title="Gestione Manuale">üõ†Ô∏è</a>
    </div>

    <div class="match-body">
        
        {# --- TEAM BLU --- #}
        {% set is_blue_single = (m.t1_p1 == 'CLOSED' or m.t1_p2 == 'CLOSED') %}
        <div class="team-col {% if is_blue_single %}single-player-layout{% endif %}" style="position: relative;">
            {% if not is_blue_single %}<div class="team-header team-blue">üîµ TEAM BLU</div>{% endif %}
            
            {# IMPORTANTE: Qui dobbiamo usare la macro render_slot. 
               Se non √® disponibile in questo contesto parziale, copio il codice essenziale dello slot #}
            
            {# SLOT BLU 1 #}
            {% with slot_key='t1_p1', player=m.t1_p1 %}
                {% include 'includes/_slot_partial.html' %}
            {% endwith %}

            {# SLOT BLU 2 #}
            {% with slot_key='t1_p2', player=m.t1_p2 %}
                {% include 'includes/_slot_partial.html' %}
            {% endwith %}

            {% if is_blue_single %}
                <div class="team-header team-blue" style="position: absolute; bottom: 0; left: 0; right: 0; margin-bottom: -5px;">üîµ TEAM BLU</div>
            {% endif %}
        </div>

        <div class="live-score-display">
            {% set t1_p1_active = m.t1_p1 and m.t1_p1 != 'CLOSED' %}
            {% set t1_p2_active = m.t1_p2 and m.t1_p2 != 'CLOSED' %}
            {% set t2_p1_active = m.t2_p1 and m.t2_p1 != 'CLOSED' %}
            {% set t2_p2_active = m.t2_p2 and m.t2_p2 != 'CLOSED' %}
            {% set is_table_empty = not (t1_p1_active or t1_p2_active or t2_p1_active or t2_p2_active) %}

            {% if is_table_empty %}
                <button class="btn-delete-table" onclick="openDeleteTableModal('{{ m.id }}', '{{ url_for('main.delete_match', match_id=m.id) }}')" title="Elimina Tavolo Vuoto">üóëÔ∏è</button>
            {% else %}
                <div class="score-number blue">{{ item.score_t1 }}</div>
                <div class="score-sep"></div>
                <div class="score-number red">{{ item.score_t2 }}</div>
            {% endif %}
        </div>

        {# --- TEAM ROSSO --- #}
        {% set is_red_single = (m.t2_p1 == 'CLOSED' or m.t2_p2 == 'CLOSED') %}
        <div class="team-col {% if is_red_single %}single-player-layout{% endif %}" style="position: relative;">
            {% if is_red_single %}
                <div class="team-header team-red" style="position: absolute; top: 0; left: 0; right: 0; margin-top: -5px;">üî¥ TEAM ROSSO</div>
            {% endif %}

            {# SLOT ROSSO 1 #}
            {% with slot_key='t2_p1', player=m.t2_p1 %}
                {% include 'includes/_slot_partial.html' %}
            {% endwith %}

            {# SLOT ROSSO 2 #}
            {% with slot_key='t2_p2', player=m.t2_p2 %}
                {% include 'includes/_slot_partial.html' %}
            {% endwith %}
            
            {% if not is_red_single %}<div class="team-header team-red" style="margin-top: 5px;">üî¥ TEAM ROSSO</div>{% endif %}
        </div>
    </div>
</div>