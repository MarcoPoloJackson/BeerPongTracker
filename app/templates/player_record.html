{% extends "base.html" %}

{% block title %}{{ titolo }}{% endblock %}

{% block body_class %}
{# AGGIUNTO 'preload' ALL'INIZIO #}
preload {% if redemption_info and redemption_info.active and redemption_info.is_me %}redemption-active-me{% endif %}
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/redemption.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/table/table.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/table/formato.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/table/multi_hits.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/overtime.css') }}">
    {# Il CSS specifico per il tasto team ora √® in main.css (header-team-badge) #}
{% endblock %}

{% block content %}

    {% include 'includes/overtime.html' %}
    {% include 'includes/game_over_overlay.html' %}

    {# Animazione Formato #}
    <div id="format-overlay">
        <div class="format-content-wrapper">
            <div id="format-shape" class="format-shape"></div> 
            <div id="format-text" class="format-text"></div>   
        </div>
    </div>

    {% if not game_result %}
    <div class="container">
        
        {# HEADER RIVOLUZIONATO: 3 COLONNE (Esci - Squadra - Nome) #}
        <div class="nav-header" style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
            
            <a href="{{ url_for('main.home') }}" class="btn-back" target="_top">‚¨Ö Esci</a>

            {% if teammate and teammate != 'CLOSED' %}
                {% if is_split_context %}
                    {# Caso: Dentro Iframe (Vista Doppia) #}
                    <a href="{{ url_for('main.index', player_name=player_name) }}" target="_top" class="header-team-badge active-green" style="text-decoration: none; text-align: center; flex-grow: 1; max-width: 200px;">
                        <small style="display:block; font-size:0.7em;">Vista Doppia</small>
                        <strong style="font-size:0.9em;">Torna Singolo</strong>
                    </a>
                {% else %}
                    {# Caso: Vista Normale (Cliccabile per menu) #}
                    <div id="team-header-btn" 
                         class="header-team-badge {% if not teammate_obj.edit and not is_super_admin %}locked{% endif %}"
                         onclick="handleTeamClick()"
                         style="text-align: center; cursor: pointer; flex-grow: 1; max-width: 220px; background: #e3f2fd; border: 1px solid #90caf9; padding: 5px 10px; border-radius: 50px; color: #1565c0;">
                        
                        <div style="line-height: 1;">
                            <small style="font-size: 0.7em; opacity: 0.8; text-transform: uppercase;">In squadra con</small>
                        </div>
                        <div style="line-height: 1.2; display: flex; align-items: center; justify-content: center; gap: 4px;">
                            <strong id="teammate-name-display" style="font-size: 1em;">{{ teammate }}</strong>
                            {% if not teammate_obj.edit and not is_super_admin %}
                                <span style="font-size: 0.8em;">üîí</span>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% else %}
                {# Spaziatore vuoto se non c'√® squadra, per mantenere il nome a destra #}
                <div style="flex-grow: 1;"></div>
            {% endif %}

            <div class="header-player-name" style="text-align: right;">
                <div style="font-weight: 800; font-size: 1.1em; color: #34495e;">{{ player_name }}</div>
            </div>
        </div>

        {# Messaggio di errore discreto (se il compagno √® bloccato) #}
        {% if teammate and teammate != 'CLOSED' and not is_split_context and not teammate_obj.edit and not is_super_admin %}
            <div id="team-error-msg" style="text-align: center; font-size: 0.75em; color: #c0392b; margin-top: -15px; margin-bottom: 15px; opacity: 0.9;">
            </div>
        {% endif %}

        {% include 'includes/redemption.html' %}
        
        {# ... QUI INIZIA IL FORM GIOCO (NON MODIFICATO) ... #}

        {# FORM GIOCO #}
        <form action="{{ url_for('main.add_record', player_name=player_name) }}" method="POST" id="gameForm">
            <div class="form-group spacing-top">
                <div class="section-title">Risultato del Tiro</div>
                <div class="result-options">
                    <input type="radio" id="opt_miss" name="risultato_tiro" value="Miss" onclick="handleResultClick('Miss')">
                    <label for="opt_miss" class="result-label" style="position: relative; overflow: hidden;">
                        <span class="content"><span class="result-icon">‡ºÑ</span>MISS</span>
                        <div class="mini-weather-box">
                            <div class="mini-wind mw1"></div><div class="mini-wind mw2"></div>
                            <div class="mini-leaf lf1">üçÉ</div><div class="mini-leaf lf2">üçÇ</div>
                        </div>
                    </label>
                    <input type="radio" id="opt_bordo" name="risultato_tiro" value="Bordo" onclick="handleResultClick('Bordo')">
                    <label for="opt_bordo" class="result-label bordo-wall">
                        <span class="content"><span class="result-icon">üß±</span>BORDO</span>
                        <div class="brick-wall"></div>
                    </label>
                    <input type="radio" id="opt_centro" name="risultato_tiro" value="Centro" onclick="handleResultClick('Centro')">
                    <label for="opt_centro" class="result-label"><span class="result-icon">üéØ</span>CENTRO</label>
                </div>
            </div>

            {% include 'includes/table.html' %}

            <div class="form-group">
                <div class="section-title">Bevanda</div>
                <input type="text" id="bevanda" name="bevanda" value="{{ defaults.bevanda }}" placeholder="Es. Birra">
            </div>

            <div class="form-group">
                <div class="section-title">Note</div>
                <textarea id="note" name="note" rows="1" placeholder="Note opzionali..."></textarea>
            </div>

            <div class="form-group">
                <div class="section-title">Postazione</div>
                <div class="table-field-container">
                    <div class="positions-row">
                        <input type="radio" id="pos_sinistra" name="postazione" value="Sinistra" {% if defaults.postazione == 'Sinistra' %}checked{% endif %}>
                        <label for="pos_sinistra" class="pos-pad"><span class="pos-icon-big">‚¨ÖÔ∏è</span>SX</label>
                        
                        <input type="radio" id="pos_centrale" name="postazione" value="Centrale" {% if defaults.postazione == 'Centrale' %}checked{% endif %}>
                        <label for="pos_centrale" class="pos-pad"><span class="pos-icon-big">‚è∫Ô∏è</span>CEN</label>
                        
                        <input type="radio" id="pos_destra" name="postazione" value="Destra" {% if defaults.postazione == 'Destra' %}checked{% endif %}>
                        <label for="pos_destra" class="pos-pad"><span class="pos-icon-big">‚û°Ô∏è</span>DX</label>
                    </div>
                </div>
            </div>
        </form>

        {# BANNER SCALA #}
        {% if waiting_for_opponent and waiting_for_opponent > 0 and not match_status.startswith('redemption') %}
            <div style="margin: 40px 0 20px 0;"><hr style="border: 0; border-top: 2px dashed #cfd8dc; margin-bottom: 25px;"></div>
            <div class="info-card fade-in" style="background:#e3f2fd; border-left: 5px solid #2196F3; color:#0d47a1; display:flex; align-items:center; justify-content:space-between; gap:15px; padding: 20px; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15); margin-bottom: 30px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <span style="font-size:2em;">üéØ</span>
                    <div>
                        <strong style="font-size: 1.1em; letter-spacing: 0.5px;">PENDING HIT!</strong>
                        <span style="font-size:0.95em; display:block; opacity: 0.8;">Ci sono <b>{{ waiting_for_opponent }}</b> bicchieri da togliere.</span>
                    </div>
                </div>
                <form action="{{ url_for('main.force_update', player_name=player_name) }}" method="POST" style="margin:0; padding:0; width:auto; box-shadow:none; background:transparent;">
                    <button type="submit" class="btn-force" style="background:#2196F3; color:white; padding: 12px 20px; border-radius: 10px; font-weight: 800; border: none; cursor: pointer;">SCALA ORA</button>
                </form>
            </div>
        {% endif %}

        {# STORICO TIRI #}
        <div class="history-section">
            <div class="section-title" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <span>Ultimi Tiri</span>
                <small style="font-size:0.7em; color:#888;">Sessione corrente</small>
            </div>
            <ul class="history-list">
                {% for riga in dati %}
                    {% set card_class = 'border-miss' %}
                    {% set text_color = '#7f8c8d' %}
                    {% set main_icon = 'üí®' %}
                    {% set main_label = 'MISS' %}
                    {% if riga["Centro"] == 'S√¨' %}
                        {% set card_class = 'border-centro' %}
                        {% set text_color = '#2e7d32' %}
                        {% set main_icon = 'üéØ' %}
                        {% set main_label = 'CENTRO' %}
                    {% elif riga["Bordo"] == 'S√¨' %}
                        {% set card_class = 'border-bordo' %}
                        {% set text_color = '#e65100' %}
                        {% set main_icon = 'üß±' %}
                        {% set main_label = 'BORDO' %}
                    {% endif %}
                    
                    {% set d_text = riga["Bevanda"]|lower %}
                    {% set d_emoji = 'üç∫' %} 
                    {% if 'acqua' in d_text %}{% set d_emoji = 'üíß' %}
                    {% elif 'vino' in d_text or 'rosso' in d_text %}{% set d_emoji = 'üç∑' %}
                    {% elif 'spritz' in d_text or 'aperol' in d_text %}{% set d_emoji = 'üçπ' %}
                    {% elif 'jager' in d_text or 'bomb' in d_text or 'amaro' in d_text %}{% set d_emoji = 'ü•É' %}
                    {% elif 'gin' in d_text or 'vodka' in d_text or 'tonic' in d_text %}{% set d_emoji = 'üç∏' %}
                    {% elif 'coca' in d_text or 'pepsi' in d_text %}{% set d_emoji = 'ü•§' %}
                    {% elif 'caff√®' in d_text or 'coffee' in d_text %}{% set d_emoji = '‚òï' %}
                    {% endif %}

                    <li class="history-card {{ card_class }}" style="position: relative; padding-right: 70px;">
                        <div class="h-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span class="h-result" style="font-weight: 900; font-size: 1.1em; color: {{ text_color }};">
                                {{ main_icon }} {{ main_label }}
                            </span>
                            <span class="h-time" style="font-size: 0.85em; color: #999;">{{ riga["Data"] }}</span>
                        </div>
                        <div style="font-size:0.9em; color:#444;">
                            {% if riga["Centro"] == "S√¨" and riga["Colpiti"] and riga["Colpiti"] != "N/A" %}
                                <div style="background: rgba(46, 125, 50, 0.08); padding: 6px 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #2e7d32;">
                                    <strong style="color:#1b5e20; font-size:0.9em;">Colpiti:</strong>
                                    <span style="font-family: monospace; font-size: 1.1em; color:#000;">{{ riga["Colpiti"] }}</span>
                                </div>
                            {% endif %}
                            <div class="h-detail" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                {% if riga["Posizione"] %}<span class="tag" style="background:#f5f5f5; border:1px solid #ddd; color:#555;">üìç {{ riga["Posizione"] }}</span>{% endif %}
                                <span class="tag" style="background-color: #fff8e1; color: #f57f17; border: 1px solid #ffe082;">{{ d_emoji }} {{ riga["Bevanda"] }}</span>
                                {% if riga["Salvezza"] == "S√¨" %}<span class="tag" style="background:#ffcdd2; color:#b71c1c; border:1px solid #e57373; font-weight:bold;">üõ°Ô∏è Salvezza</span>{% endif %}
                                {% if riga["Multipli"] and riga["Multipli"] != "-" and riga["Multipli"] != "" %}<span class="tag" style="background:#e1f5fe; color:#0277bd; border:1px solid #4fc3f7; font-weight:bold;">‚ö° {{ riga["Multipli"] }}</span>{% endif %}
                            </div>
                            {% if riga["Note"] %}<div style="margin-top:8px; padding-top:5px; border-top:1px dashed #eee; font-style:italic; font-size:0.85em; color:#666;">üìù "{{ riga["Note"] }}"</div>{% endif %}
                        </div>
                        
                        {# --- TASTI AZIONE --- #}
                        <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px;">
                            <a href="{{ url_for('main.edit_record', player_name=player_name, id=riga['ID']) }}" 
                               class="btn-edit-history" 
                               title="Modifica"
                               style="font-size: 1.2em; color: #3498db; cursor: pointer; text-decoration: none; padding: 2px;">
                               ‚úèÔ∏è
                            </a>
                            <form method="POST" action="{{ url_for('main.delete_record', player_name=player_name, id=riga['ID']) }}" 
                                  onsubmit="return confirm('Vuoi cancellare questo tiro? (ID: {{ riga["ID"] }})');" 
                                  style="margin: 0; padding: 0; background: none; box-shadow: none; width: auto;">
                                <button type="submit" class="btn-del-history" style="font-size: 1.2em; color: #ccc; cursor: pointer; background: transparent; border: none; padding: 2px;">&times;</button>
                            </form>
                        </div>
                    </li>
                {% else %}
                    <li style="text-align:center; color:#ccc; margin-top:30px; font-style: italic;">Non hai ancora effettuato tiri in questa sessione.</li>
                {% endfor %}
            </ul>
        </div>
    </div> 
    {% endif %}

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<script>
    // --- VARIABILI GLOBALI (Necessarie per i file JS esterni) ---
    let rehits = []; 
    
    // Dati Jinja passati a Window
    window.teammateName = "{{ teammate }}";
    window.myPlayerName = "{{ player_name }}";
    window.teamViewUrl = "{{ url_for('main.team_mode', player_name=player_name) }}";

    const activeCupsOpponent = {{ defaults.opp_active_cups | tojson | default('[]') }};
    const activeCupsMe = {{ defaults.my_active_cups | tojson | default('[]') }};
    const pendingCups = {{ defaults.opp_pending_cups | tojson | default('[]') }};
    const myPendingCups = {{ defaults.my_pending_cups | tojson | default('[]') }};

    const serverCupsTarget = "{{ defaults.numero_bicchieri }}"; 
    const serverOppFormat = "{{ defaults.formato }}"; 
    const serverMyFormat = "{{ defaults.my_formato }}";
    
    const isMatchActive = {{ is_match | tojson | default('false') }};
    const gameResult = "{{ game_result if game_result else '' }}";
    const triggerAnimation = {{ show_animation | tojson | default('false') }};
    const myMatchId = {{ defaults.match_id | default(0) }};


    window.isSuperAdmin = {{ is_super_admin | tojson | default('false') }};

    // ==========================================
    //  SCRIPT MEMORIA POSTAZIONE (NUOVO)
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
        // Chiave unica per questo giocatore
        const posKey = "last_position_" + window.myPlayerName;
        
        // 1. Controlla se c'√® una posizione salvata in memoria
        const savedPos = localStorage.getItem(posKey);
        
        if (savedPos) {
            // Se esiste, seleziona il radio button corrispondente
            const radio = document.querySelector(`input[name="postazione"][value="${savedPos}"]`);
            if (radio) radio.checked = true;
        }

        // 2. Salva la posizione ogni volta che la cambi
        const radios = document.querySelectorAll('input[name="postazione"]');
        radios.forEach(r => {
            r.addEventListener('change', (e) => {
                localStorage.setItem(posKey, e.target.value);
            });
        });
    });
</script>

{# CARICAMENTO MODULARE #}
<script src="{{ url_for('static', filename='js/game/config.js') }}"></script>
<script src="{{ url_for('static', filename='js/game/ui.js') }}"></script>
<script src="{{ url_for('static', filename='js/game/logic.js') }}"></script>

{% endblock %}