{% extends "base.html" %}

{% block title %}{{ titolo }}{% endblock %}

{# LOGICA PER LA CLASSE CSS NEL BODY #}
{% block body_class %}
{% if redemption_info and redemption_info.active and redemption_info.is_me %}redemption-active-me{% endif %}
{% endblock %}

{% block styles %}
    {# CSS dedicato al redemption e al tavolo #}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/redemption.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/table/table.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/table/formato.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/table/multi_hits.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/overtime.css') }}">
{% endblock %}

{% block content %}

    {# --- INIEZIONE LOGICA E RESTYLING OVERTIME --- #}
    {# Questo file caricher√† il CSS che trasforma la pagina da bianca a Dark/Neon #}
    {% include 'includes/overtime.html' %}
    
    {# --- 1. OVERLAY DI FINE PARTITA --- #}
    {% include 'includes/game_over_overlay.html' %}

    {# ... resto del codice invariato ... #}

    {# --- 2. ANIMAZIONE FORMATO (Overlay temporaneo) --- #}
    <div id="format-overlay">
        <div class="format-content-wrapper">
            <div id="format-shape" class="format-shape"></div> 
            <div id="format-text" class="format-text"></div>   
        </div>
    </div>


    {# ================================================================= #}
    {#   SE LA PARTITA NON √à FINITA, MOSTRA L'INTERFACCIA DI GIOCO       #}
    {# ================================================================= #}
    {% if not game_result %}

    <div class="container fade-in">
        
        {# --- HEADER NAVIGAZIONE --- #}
        <div class="nav-header">
            <a href="{{ url_for('main.select_player') }}" class="btn-back">‚¨Ö Esci</a>
            <div style="font-weight: 800; font-size: 1.1em; color: #34495e;">{{ player_name }}</div>
            <div style="width: 40px; height: 40px;"></div> 
        </div>

        {# --- PULSANTE SQUADRA / VISTA DOPPIA --- #}
        {% if teammate %}
            {% if is_split_context %}
                {# SE SIAMO DENTRO L'IFRAME (VISTA DOPPIA) #}
                <a href="{{ url_for('main.index', player_name=player_name) }}" target="_top" style="text-decoration: none; color: inherit; display: block;">
                    <div class="info-card info-team split-active-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>‚Ü©Ô∏è TORNA A SINGOLO:</strong> {{ player_name }}
                            </div>
                            <div class="split-badge active">üì± VISTA DOPPIA ATTIVA</div>
                        </div>
                    </div>
                </a>
            {% else %}
                {# SE SIAMO IN VISTA NORMALE #}
                <a href="{{ url_for('main.team_mode', player_name=player_name) }}" style="text-decoration: none; color: inherit; display: block;">
                    <div class="info-card info-team normal-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>üîó SQUADRA:</strong> Con <strong>{{ teammate }}</strong>
                            </div>
                            <div class="split-badge">üì± VISTA DOPPIA</div>
                        </div>
                    </div>
                </a>
            {% endif %}
            
            <style>
                .info-team { cursor: pointer; transition: all 0.2s ease-in-out; }
                .split-badge { background: rgba(0,0,0,0.05); padding: 5px 10px; border-radius: 8px; font-size: 0.8em; color: #555; transition: all 0.2s;}
                .normal-card:hover { transform: scale(1.02); box-shadow: 0 6px 15px rgba(0,0,0,0.1); background-color: #f0faff; border-left-color: #2196F3; }
                .split-active-card { background-color: #e8f5e9; border-left-color: #2ecc71; box-shadow: inset 0 0 10px rgba(46, 204, 113, 0.1); }
                .split-active-card:hover { background-color: #d4edda; transform: translateY(-2px); }
                .split-badge.active { background: #2ecc71; color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3); }
            </style>
        {% endif %}

        {# --- INCLUDE BARRA TIRI SALVEZZA (Se attiva) --- #}
        {% include 'includes/redemption.html' %}

    

        {# --- FORM PRINCIPALE DI GIOCO --- #}
        <form action="{{ url_for('main.add_record', player_name=player_name) }}" method="POST" id="gameForm">
            
            <div class="form-group">
                <div class="section-title">Risultato del Tiro</div>
                <div class="result-options">
                    <input type="radio" id="opt_miss" name="risultato_tiro" value="Miss" onclick="handleResultClick('Miss')">
                    <label for="opt_miss" class="result-label" style="position: relative; overflow: hidden;">
                        <span class="content"><span class="result-icon">‡ºÑ</span>MISS</span>
                        <div class="mini-weather-box">
                            <div class="mini-wind mw1"></div><div class="mini-wind mw2"></div>
                            <div class="mini-leaf lf1">üçÉ</div><div class="mini-leaf lf2">üçÇ</div>
                        </div>
                    </label>
                    
                    <input type="radio" id="opt_bordo" name="risultato_tiro" value="Bordo" onclick="handleResultClick('Bordo')">
                    <label for="opt_bordo" class="result-label bordo-wall">
                        <span class="content"><span class="result-icon">üß±</span>BORDO</span>
                        <div class="brick-wall"></div>
                    </label>

                    <input type="radio" id="opt_centro" name="risultato_tiro" value="Centro" onclick="handleResultClick('Centro')">
                    <label for="opt_centro" class="result-label"><span class="result-icon">üéØ</span>CENTRO</label>
                </div>
            </div>

            {# --- INCLUDE GESTIONE TAVOLO (Bicchieri e Formati) --- #}
            {% include 'includes/table.html' %}

            <div class="form-group">
                <div class="section-title">Bevanda</div>
                <input type="text" id="bevanda" name="bevanda" value="{{ defaults.bevanda }}" placeholder="Es. Birra">
            </div>

            <div class="form-group">
                <div class="section-title">Note</div>
                <textarea id="note" name="note" rows="1" placeholder="Note opzionali..."></textarea>
            </div>

            <div class="form-group">
                <div class="section-title">Postazione</div>
                <div class="table-field-container">
                    <div class="positions-row">
                        <input type="radio" id="pos_sinistra" name="postazione" value="Sinistra" {% if defaults.postazione == 'Sinistra' %}checked{% endif %}>
                        <label for="pos_sinistra" class="pos-pad"><span class="pos-icon-big">‚¨ÖÔ∏è</span>SX</label>

                        <input type="radio" id="pos_centrale" name="postazione" value="Centrale" {% if defaults.postazione == 'Centrale' %}checked{% endif %}>
                        <label for="pos_centrale" class="pos-pad"><span class="pos-icon-big">‚è∫Ô∏è</span>CEN</label>

                        <input type="radio" id="pos_destra" name="postazione" value="Destra" {% if defaults.postazione == 'Destra' %}checked{% endif %}>
                        <label for="pos_destra" class="pos-pad"><span class="pos-icon-big">‚û°Ô∏è</span>DX</label>
                    </div>
                </div>
            </div>

        </form>

        {# --- SPAZIO E BANNER SCALA (Fuori dal form principale) --- #}
        {% if waiting_for_opponent and waiting_for_opponent > 0 and not match_status.startswith('redemption') %}
            
            <div style="margin: 40px 0 20px 0;">
                <hr style="border: 0; border-top: 2px dashed #cfd8dc; margin-bottom: 25px;">
            </div>

            <div class="info-card fade-in" style="background:#e3f2fd; border-left: 5px solid #2196F3; color:#0d47a1; display:flex; align-items:center; justify-content:space-between; gap:15px; padding: 20px; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15); margin-bottom: 30px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <span style="font-size:2em;">üéØ</span>
                    <div>
                        <strong style="font-size: 1.1em; letter-spacing: 0.5px;">PENDING HIT!</strong>
                        <span style="font-size:0.95em; display:block; opacity: 0.8;">Ci sono <b>{{ waiting_for_opponent }}</b> bicchieri da togliere.</span>
                    </div>
                </div>
                
                <form action="{{ url_for('main.force_update', player_name=player_name) }}" method="POST" style="margin:0; padding:0; width:auto; box-shadow:none; background:transparent;">
                    <button type="submit" class="btn-force" style="background:#2196F3; color:white; padding: 12px 20px; border-radius: 10px; font-weight: 800; border: none; cursor: pointer;">
                        SCALA ORA
                    </button>
                </form>
            </div>
        {% endif %}

        {# --- STORICO TIRI CON EMOJI --- #}
        <div class="history-section">
            <div class="section-title" style="margin-bottom:10px;">Ultimi Tiri</div>
            <ul class="history-list">
                {% for riga in dati %}
                    {% set border_class = 'border-miss' %}
                    {% if riga["Centro"] == 'S√¨' %}{% set border_class = 'border-centro' %}
                    {% elif riga["Bordo"] == 'S√¨' %}{% set border_class = 'border-bordo' %}{% endif %}

                    {# --- LOGICA EMOJI BEVANDA (Nuova) --- #}
                    {% set d_text = riga["Bevanda"]|lower %}
                    {% set d_emoji = 'üç∫' %} {# Default Birra #}
                    
                    {% if 'acqua' in d_text %}{% set d_emoji = 'üíß' %}
                    {% elif 'vino' in d_text or 'rosso' in d_text %}{% set d_emoji = 'üç∑' %}
                    {% elif 'spritz' in d_text or 'aperol' in d_text %}{% set d_emoji = 'üçπ' %}
                    {% elif 'jager' in d_text or 'bomb' in d_text or 'amaro' in d_text %}{% set d_emoji = 'ü•É' %}
                    {% elif 'gin' in d_text or 'vodka' in d_text or 'tonic' in d_text %}{% set d_emoji = 'üç∏' %}
                    {% elif 'coca' in d_text or 'pepsi' in d_text %}{% set d_emoji = 'ü•§' %}
                    {% elif 'caff√®' in d_text or 'coffee' in d_text %}{% set d_emoji = '‚òï' %}
                    {% endif %}

                    <li class="history-card {{ border_class }}">
                        <div class="h-header">
                            <span class="h-result" style="color: {% if riga['Centro']=='S√¨' %}#2e7d32{% elif riga['Bordo']=='S√¨' %}#ef6c00{% else %}#7f8c8d{% endif %};">
                                {% if riga["Centro"] == 'S√¨' %}üéØ CENTRO
                                {% elif riga["Bordo"] == 'S√¨' %}üß± BORDO
                                {% else %}‡ºÑ MISS{% endif %}
                            </span>
                            
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="h-time">{{ riga["Data"] }}</span>
                                <form method="POST" action="{{ url_for('main.delete_record', player_name=player_name, id=riga['ID']) }}" onsubmit="return confirm('Cancellare ID {{ riga["ID"] }}?');" style="box-shadow:none; padding:0; display:inline; background:transparent; width:auto;">
                                    <button type="submit" class="btn-del-history">&times;</button>
                                </form>
                            </div>
                        </div>
                        <div style="font-size:0.9em; color:#444;">
                             {% if riga["Centro"] == "S√¨" %}
                                <div style="color: #2e7d32; font-weight:bold; margin-bottom: 4px;">Colpiti: {{ riga["Colpiti"] }}</div>
                            {% endif %}
                            
                            <div class="h-detail">
                                {# TAG POSIZIONE #}
                                <span class="tag">üìç {{ riga["Posizione"] }}</span>

                                {# TAG BEVANDA (NUOVO) #}
                                <span class="tag" style="background-color: #fff8e1; color: #f57f17; border: 1px solid #ffe082;">
                                    {{ d_emoji }} {{ riga["Bevanda"] }}
                                </span>

                                {# ALTRI TAG #}
                                {% if riga["Salvezza"] == "S√¨" %}<span class="tag tag-imp">üõ°Ô∏è Salvezza</span>{% endif %}
                                {% if riga["Multipli"] and riga["Multipli"] != "-" %} <span class="tag" style="background:#e8f5e9; color:#2e7d32;">‚ö° {{ riga["Multipli"] }}</span> {% endif %}
                            </div>
                            
                            {# NOTE (Se presenti) #}
                            {% if riga["Note"] %}
                                <div style="margin-top:5px; font-style:italic; font-size:0.85em; color:#666;">
                                    üìù "{{ riga["Note"] }}"
                                </div>
                            {% endif %}
                        </div>
                    </li>
                {% else %}
                    <li style="text-align:center; color:#ccc; margin-top:20px;">Nessun tiro recente.</li>
                {% endfor %}
            </ul>
        </div>
        
    </div> {% endif %} 
    {# --- FINE DEL BLOCCO IF NOT GAME_RESULT --- #}

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<script>
    // --- VARIABILI GLOBALI DI STATO ---
    let rehits = []; 

    const activeCupsOpponent = {{ defaults.opp_active_cups | tojson | default('[]') }};
    const activeCupsMe = {{ defaults.my_active_cups | tojson | default('[]') }};
    const pendingCups = {{ defaults.opp_pending_cups | tojson | default('[]') }};
    const myPendingCups = {{ defaults.my_pending_cups | tojson | default('[]') }};

    const serverCupsTarget = "{{ defaults.numero_bicchieri }}"; 
    const serverOppFormat = "{{ defaults.formato }}"; 
    const serverMyFormat = "{{ defaults.my_formato }}";
    
    const isMatchActive = {{ is_match | tojson | default('false') }};
    const gameResult = "{{ game_result if game_result else '' }}";

    // --- VARIABILI SPECIALI ---
    // 1. Trigger Animazione (se Flask dice di farla partire)
    const triggerAnimation = {{ show_animation | tojson | default('false') }};
    
    // 2. ID Partita (per sapere quale aggiornare via WebSocket)
    const myMatchId = {{ defaults.match_id | default(0) }};

    document.addEventListener("DOMContentLoaded", function() {
        
        // --- LOGICA COLORE BEVANDA ---
        const drinkInput = document.getElementById('bevanda');
        
        if (drinkInput) {
            function updateDrinkColor() {
                const text = drinkInput.value.toLowerCase().trim();
                
                // Rimuove tutte le classi drink precedenti
                drinkInput.classList.remove(
                    'drink-water', 'drink-beer', 'drink-spritz', 
                    'drink-wine', 'drink-jager', 'drink-coke', 
                    'drink-ginlemon', 'drink-gintonic'
                );

                // Assegna la classe in base al testo (include parziale)
                if (text.includes('acqua')) {
                    drinkInput.classList.add('drink-water');
                } 
                else if (text.includes('birra') || text.includes('cerveza')) {
                    drinkInput.classList.add('drink-beer');
                }
                else if (text.includes('spritz') || text.includes('aperol') || text.includes('campari')) {
                    drinkInput.classList.add('drink-spritz');
                }
                else if (text.includes('vino') || text.includes('rosso') || text.includes('bianco')) {
                    drinkInput.classList.add('drink-wine');
                }
                else if (text.includes('jager') || text.includes('bomb')) {
                    drinkInput.classList.add('drink-jager');
                }
                else if (text.includes('coca') || text.includes('pepsi')) {
                    drinkInput.classList.add('drink-coke');
                }
                else if (text.includes('gin lemon') || text.includes('lemon')) {
                    drinkInput.classList.add('drink-ginlemon');
                }
                else if (text.includes('gin tonic') || text.includes('tonic') || text.includes('gin')) {
                    drinkInput.classList.add('drink-gintonic');
                }
            }

            // Attiva l'evento mentre scrivi e al caricamento pagina
            drinkInput.addEventListener('input', updateDrinkColor);
            updateDrinkColor(); // Per colorare se c'√® gi√† un valore salvato
        }
    });

</script>

{# CARICAMENTO MODULARE DEL GIOCO #}
<script src="{{ url_for('static', filename='js/game/config.js') }}"></script>
<script src="{{ url_for('static', filename='js/game/ui.js') }}"></script>
<script src="{{ url_for('static', filename='js/game/logic.js') }}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        // --- A. LOGICA ANIMAZIONE FORMATO ---
        if (triggerAnimation === true && typeof playFormatAnimation === "function") {
            playFormatAnimation(serverOppFormat);
        }

        // --- B. LOGICA WEBSOCKET (AGGIORNAMENTO PAGINA) ---
        // Verifica se la libreria √® caricata
        if (typeof io !== 'undefined') {
            const socket = io();

            // Debug connessione
            socket.on('connect', function() {
                console.log("Socket connesso: In ascolto di aggiornamenti...");
            });

            // Ascolta l'evento 'partita_aggiornata' dal server
            socket.on('partita_aggiornata', function(data) {
                console.log("Aggiornamento ricevuto per match ID:", data.match_id);
                
                // Se l'aggiornamento riguarda QUESTA partita, ricarica la pagina
                if (data.match_id === myMatchId) {
                    console.log("Corrisponde alla mia partita! Ricarico...");
                    location.reload(); 
                }
            });
        } else {
            console.warn("Attenzione: Libreria Socket.IO non trovata. L'auto-refresh non funzioner√†.");
        }
    });
</script>
{% endblock %}