{% extends "base.html" %}

{% block title %}Sala Giochi - Beer Pong{% endblock %}

{% block styles %}
    {# STILI HOME #}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home/home.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home/tavoli.css') }}">
{% endblock %}

{% block content %}
    {# ... resto del codice ... #}

    {# --- MACRO SLOT GIOCATORE --- #}
    {% macro render_slot(match, slot_key, score, players) %}
        {% set player = match[slot_key] %}
        
        {# --- LOGICA VISUALIZZAZIONE --- #}
        {# Se il valore √® 'CLOSED' (impostato dal tasto Nessuno), NON renderizziamo nulla #}
        {% if player != 'CLOSED' %}
            
            {# Verifica se l'utente corrente √® gi√† occupato #}
            {% set am_i_busy = current_user in busy_players %}
            {% set is_me = (player == current_user) %}

            <div class="slot-box 
                {% if player %}filled{% else %}empty{% endif %} 
                {% if is_me %}my-seat{% endif %}" 
                
                {% if not player %}
                    {# Se vuoto: Click per sedersi o assegnare #}
                    {% if am_i_busy %}
                        onclick="openModal('{{ match.id }}', '{{ slot_key }}')"
                        style="cursor: pointer;" title="Assegna un altro giocatore"
                    {% else %}
                        onclick="instantJoin('{{ match.id }}', '{{ slot_key }}', '{{ current_user }}')"
                        style="cursor: pointer;" title="Siediti qui"
                    {% endif %}
                {% else %}
                    style="cursor: default;"
                {% endif %}
            >

                {% if player %}
                    {# --- CASO 1: OCCUPATO --- #}
                    {% set found_p = players|selectattr("name", "equalto", player)|list %}
                    {% set p_obj = found_p[0] if found_p else None %}
                    
                    <a href="{{ url_for('main.index', player_name=player) }}" class="player-link" title="{{ player }}">
                        <span class="mini-avatar">
                            {% if p_obj and p_obj.icon %}
                                {{ p_obj.icon }}
                            {% else %}
                                {{ player[:1] | upper }}
                            {% endif %}
                        </span>
                        <span class="player-name-text">
                            {{ player }}
                            {% if is_me %}<span style="opacity:0.6; font-size:0.8em; margin-left:4px;">(Tu)</span>{% endif %}
                        </span>
                    </a>
                    
                    <button class="btn-kick" title="Rimuovi" 
                       onclick="event.stopPropagation(); openKickModal('{{ player }}', '{{ url_for('main.remove_player_slot', match_id=match.id, slot=slot_key) }}');">
                        &times;
                    </button>

                {% else %}
                    {# --- CASO 2: VUOTO (Mostra bottone +) --- #}
                    {% if am_i_busy %}
                        <button class="btn-join">Ôºã Assegna</button>
                    {% else %}
                        <button class="btn-join">Ôºã Siediti</button>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %} {# Fine controllo CLOSED #}
    {% endmacro %}


    <div class="container home-container">
        
        {# --- HEADER UTENTE --- #}
        <div class="dashboard-header">
            {% set found_me = players|selectattr("name", "equalto", current_user)|list %}
            {% set me = found_me[0] if found_me else None %}

            <a href="{{ url_for('main.icon_page') }}" class="player-identity" style="text-decoration:none; color:inherit;" title="Cambia Icona">
                <div class="identity-avatar">
                    {% if me and me.icon %}
                        {{ me.icon }}
                    {% else %}
                        {{ current_user[:1] | upper }}
                    {% endif %}
                </div>
                
                <div class="identity-info">
                    <span class="id-label">Accesso effettuato come</span>
                    <span class="id-name">
                        {{ current_user }} 
                        <span style="font-size:0.8em; opacity:0.5; margin-left:5px;">‚úèÔ∏è</span>
                    </span>
                </div>
            </a>

            <div class="header-controls">
                <form action="{{ url_for('main.toggle_edit') }}" method="POST" class="toggle-form">
                    <label class="edit-toggle-wrapper">
                        <input type="checkbox" onchange="this.form.submit()" {% if me and me.edit %}checked{% endif %}>
                        <div class="toggle-visual"><span class="toggle-knob"></span></div>
                        <span class="toggle-label-text">Condividi</span>
                    </label>
                </form>
                <a href="{{ url_for('main.logout') }}" class="btn-logout">
                    <span class="logout-icon">‚èª</span>
                     <span class="logout-text">Logout</span>
                </a>
            </div>
        </div>

        <h1 class="page-title">üç∫ Beer Pong Arena</h1>
        <p class="page-subtitle">Scegli un tavolo o creane uno nuovo</p>

        {# --- ACTION BAR --- #}
        <div class="action-bar">
            <a href="{{ url_for('main.create_match_quick') }}" class="btn-main btn-new">Ôºã Crea Tavolo Vuoto</a>
            <a href="{{ url_for('main.grafici_home') }}" class="btn-main btn-manage">üìä GRAFICI</a>
        </div>

        <h2 class="section-label">üî¥ TAVOLI ATTIVI</h2>
        
        {% if matches_data %}
            <div class="matches-grid">
                {% for item in matches_data %}
                    {% set m = item.match %}
                    
                    {# Sostituisci tutto il codice manuale con questo include #}
                    {% include 'includes/single_match_card.html' %}

                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <span class="empty-icon">üç∫</span>
                <strong>Sala vuota!</strong><br>
                <small>Crea il primo tavolo per iniziare la serata.</small>
            </div>
        {% endif %}

        <div style="margin-top: 60px;"></div>
        <h2 class="section-label">üìú STORICO 24H</h2>

        {% if grouped_history %}
            <div class="history-grid">
                {% for key, matches in grouped_history.items() %}
                    {% set reference = matches[0].obj %}
                    
                    <div class="series-card fade-in">
                        <div class="series-header">
                            <div class="series-vs">
                                <div class="team-names-hist">
                                    <span class="team-blue-text">
                                        {{ reference.t1_p1 or '?' }} {% if reference.t1_p2 %}& {{ reference.t1_p2 }}{% endif %}
                                    </span>
                                    <span class="vs-divider">VS</span>
                                    <span class="team-red-text">
                                        {{ reference.t2_p1 or '?' }} {% if reference.t2_p2 %}& {{ reference.t2_p2 }}{% endif %}
                                    </span>
                                </div>
                            </div>
                            <a href="{{ url_for('main.rematch', match_id=reference.id) }}" class="btn-history-rematch" title="Rigioca">
                                üîÑ RIGIOCA
                            </a>
                        </div>

                        <div class="history-list">
                            {% for m in matches %}
                                <div class="history-row {% if m.winner == 't1' %}win-blue{% elif m.winner == 't2' %}win-red{% endif %}">
                                    <div class="history-time">{{ m.time_ago }}</div>
                                    <div class="history-score-box">
                                        <span class="score-val blue {% if m.winner == 't1' %}winner{% endif %}">{{ m.t1_score }}</span>
                                        <span class="score-dash">-</span>
                                        <span class="score-val red {% if m.winner == 't2' %}winner{% endif %}">{{ m.t2_score }}</span>
                                    </div>
                                    <div class="history-winner-label">
                                        {% if m.winner == 't1' %}üîµ BLU{% elif m.winner == 't2' %}üî¥ ROSSI{% else %}PARI{% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    {# --- MODALI --- #}
    <div id="playerModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <h3>Scegli Giocatore</h3>
            <p id="modalSlotName" style="color:#666; font-size:0.9em; margin-bottom:10px;"></p>
            <form id="assignForm" method="POST" action="{{ url_for('main.assign_slot') }}">
                <input type="hidden" name="match_id" id="modalMatchId">
                <input type="hidden" name="slot" id="modalSlot">
                <input type="hidden" name="player_name" id="modalPlayerName">
                <div class="player-grid-modal">
                    
                    {# --- TASTO PER MODALIT√Ä SINGOLA --- #}
                    {# Invia 'CLOSED' al backend per nascondere lo slot #}
                    <div class="modal-chip chip-none" onclick="submitSelection('CLOSED')">
                        üö´ NESSUNO
                    </div>
                    
                    {% for p in players %}
                        {% set is_busy = p.name in busy_players %}
                        <div class="modal-chip {% if is_busy %}busy{% endif %}" 
                             {% if not is_busy %}onclick="submitSelection('{{ p.name }}')"{% endif %}>
                            {{ p.name }}
                            {% if is_busy %}<span style="font-size: 0.8em;">(In gioco) üîí</span>{% endif %}
                        </div>
                    {% endfor %}
                </div>
            </form>
            <div class="modal-footer">
                <button onclick="document.getElementById('playerModal').style.display='none'">ANNULLA</button>
            </div>
        </div>
    </div>

    <div id="kickModal" class="modal-overlay" onclick="closeKickModal(event)">
        <div class="modal-content" style="max-width: 400px; text-align: center;"> 
            <div class="kick-header-icon">‚ö†Ô∏è</div>
            <h3>Rimuovere Giocatore?</h3>
            <p class="kick-message">Sei sicuro di voler rimuovere <strong id="kickPlayerName">PLAYER</strong> dal tavolo?</p>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeKickModal(null, true)">Annulla</button>
                <button class="btn-modal btn-confirm-kick" onclick="confirmKick()">Rimuovi</button>
            </div>
        </div>
    </div>

    <div id="deleteTableModal" class="modal-overlay" onclick="closeDeleteTableModal(event)">
        <div class="modal-content" style="max-width: 400px; text-align: center;"> 
            <div class="kick-header-icon" style="animation: none; transform: scale(1.2);">üóëÔ∏è</div>
            <h3>Eliminare Tavolo?</h3>
            <p class="kick-message">Stai per smantellare il <strong id="delTableName">Tavolo #ID</strong>.<br>Azione irreversibile.</p>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeDeleteTableModal(null, true)">Annulla</button>
                <button class="btn-modal btn-confirm-kick" onclick="confirmTableDelete()">Elimina</button>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <script>window.currentUserName = "{{ session.get('player_name', '') }}";</script>

    <script src="{{ url_for('static', filename='js/home.js') }}"></script>
{% endblock %}