{% extends "base.html" %}

{% block title %}Sala Giochi - Beer Pong{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
{% endblock %}

{% block content %}
    <div class="container home-container">
        <h1 class="page-title">üç∫ Beer Pong Arena</h1>
        <p class="page-subtitle">Seleziona il tuo nome per entrare in partita</p>

        <div class="action-bar">
            <a href="{{ url_for('main.setup_match') }}" class="btn-main btn-new">
                Ôºã Nuovo Tavolo
            </a>
            <a href="{{ url_for('main.manage_players') }}" class="btn-main btn-manage">
                üë• Gestione Giocatori
            </a>
        </div>

        <h2 class="section-label">üî¥ LIVE MATCHES</h2>
        
        {% if matches_data %}
            <div class="matches-grid">
                {% for item in matches_data %}
                    
                    {% set mode_class = '' %}
                    {% set badge_text = 'IN CORSO' %}

                    {# 1. Controllo TIRI SALVEZZA (Redemption) #}
                    {% if 'redemption' in item.match.status %}
                        {% set mode_class = 'redemption-mode' %}
                        {% set badge_text = 'üî• TIRI SALVEZZA üî•' %}
                    
                    {# 2. Controllo OVERTIME (Ora guarda il campo 'mode' del DB) #}
                    {% elif item.match.mode == 'overtime' %}
                        {% set mode_class = 'overtime-mode' %}
                        {% set badge_text = '‚ö° OVERTIME ‚ö°' %}
                    
                    {# 3. Partita Normale #}
                    {% else %}
                        {% set badge_text = 'üü¢ IN CORSO' %}
                    {% endif %}

                    <div class="match-card fade-in {{ mode_class }}">
                        <div class="match-header">
                            <div class="match-title-group">
                                <span>#{{ item.match.id }} {{ item.match.match_name }}</span>
                                <a href="{{ url_for('main.setup_match', match_id=item.match.id) }}"
                                   class="btn-edit-match" title="Modifica Tavolo">‚úèÔ∏è</a>
                                   <a href="{{ url_for('main.manual_override', match_id=item.match.id) }}"
                                    class="btn-icon btn-manual" title="Gestione Manuale Avanzata">üõ†Ô∏è</a>
                            </div>
                            <span class="status-badge">{{ badge_text }}</span>
                        </div>

                        <div class="match-body">
                            <div class="team-col">
                                <div class="team-name team-blue">üîµ BLU</div>
                                {% if item.match.t1_p1 %}
                                    <a href="{{ url_for('main.index', player_name=item.match.t1_p1) }}" class="player-link">
                                        üë§ {{ item.match.t1_p1 }}
                                    </a>
                                {% endif %}
                                {% if item.match.t1_p2 %}
                                    <a href="{{ url_for('main.index', player_name=item.match.t1_p2) }}" class="player-link">
                                        üë§ {{ item.match.t1_p2 }}
                                    </a>
                                {% endif %}
                            </div>

                            <div class="live-score-display">
                                <div class="score-number blue">{{ item.score_t1 }}</div>
                                <div class="score-sep">-</div>
                                <div class="score-number red">{{ item.score_t2 }}</div>
                            </div>

                            <div class="team-col">
                                <div class="team-name team-red">üî¥ ROSSA</div>
                                {% if item.match.t2_p1 %}
                                    <a href="{{ url_for('main.index', player_name=item.match.t2_p1) }}" class="player-link">
                                        üë§ {{ item.match.t2_p1 }}
                                    </a>
                                {% endif %}
                                {% if item.match.t2_p2 %}
                                    <a href="{{ url_for('main.index', player_name=item.match.t2_p2) }}" class="player-link">
                                        üë§ {{ item.match.t2_p2 }}
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <span class="empty-icon">üò¥</span>
                <strong>Nessuna partita attiva.</strong><br>
                <small>Clicca "Nuovo Tavolo" per iniziare!</small>
            </div>
        {% endif %}


        <div style="margin-top: 60px;"></div>
        <h2 class="section-label">üìú MATCH HISTORY (24h)</h2>

        {% if grouped_history %}
            <div class="history-grid">
                {% for key, matches in grouped_history.items() %}
                    {% set latest = matches[0] %}
                    
                    <div class="series-card fade-in">
                        
                        <div class="series-header">
                            <div class="series-vs">
                                <span class="team-blue-text">
                                    {{ latest.obj.t1_p1 }} {% if latest.obj.t1_p2 %}& {{ latest.obj.t1_p2 }}{% endif %}
                                </span>
                                <span class="vs-text">VS</span>
                                <span class="team-red-text">
                                    {{ latest.obj.t2_p1 }} {% if latest.obj.t2_p2 %}& {{ latest.obj.t2_p2 }}{% endif %}
                                </span>
                            </div>
                            
                            <a href="{{ url_for('main.rematch_create', old_match_id=latest.obj.id) }}" class="btn-history-rematch">
                                üîÑ RIGIOCA
                            </a>
                        </div>

                        <div class="history-list">
                            {% for m in matches %}
                                <div class="history-row {% if m.winner == 't1' %}win-blue{% elif m.winner == 't2' %}win-red{% endif %}">
                                    
                                    <div class="history-time">{{ m.time_ago }}</div>
                                    
                                    <div class="history-score">
                                        <div class="score-box blue {% if m.winner == 't1' %}winner{% endif %}">
                                            <span class="cup-icon">üç∫</span> {{ m.t1_score }}
                                        </div>
                                        
                                        <div class="score-divider"></div>
                                        
                                        <div class="score-box red {% if m.winner == 't2' %}winner{% endif %}">
                                            {{ m.t2_score }} <span class="cup-icon">üç∫</span>
                                        </div>
                                    </div>

                                    <div class="history-result-badge">
                                        {% if m.winner == 't1' %}üîµ VINCE{% elif m.winner == 't2' %}üî¥ VINCE{% else %}PAREGGIO{% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="text-align: center; color: #999; margin-top: 30px;">
                Nessuna partita conclusa nelle ultime 24 ore.
            </p>
        {% endif %}
    </div>

    <script src="{{ url_for('static', filename='js/home.js') }}"></script>
{% endblock %}