{% extends "base.html" %}

{% block title %}Grafici Extra - {{ player_name }}{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/grafici/grafici_extra.css') }}">
{% endblock %}

{% block content %}
<div class="stats-container">
    
    <div class="stats-header">
        {# --- HEADER CON ICONA --- #}
        <div class="header-title-wrapper">
            
            {# Logica sicura per trovare l'icona #}
            {% set p_obj = players|selectattr("name", "equalto", player_name)|first if players is defined else None %}
            
            <div class="header-avatar-large">
                {% if p_obj and p_obj.icon %}
                    {{ p_obj.icon }}
                {% else %}
                    {{ player_name[:1]|upper }}
                {% endif %}
            </div>
            
            <h1>Statistiche Extra di {{ player_name }}</h1>
        </div>
        
       

    <div class="top-widgets" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px;">
        
        <div class="widget-insight-mini">
            <span class="label">ğŸ“ˆ Trend Successo (Oggi)</span>
            {% if comparison.played_today %}
                {% if comparison.delta_success >= 0 %}
                    <div class="value" style="color: #2ecc71;">+{{ comparison.delta_success }}%</div>
                    <div class="badge" style="background: rgba(46, 204, 113, 0.2); color: #27ae60;">Miglioramento</div>
                {% else %}
                    <div class="value" style="color: #e74c3c;">{{ comparison.delta_success }}%</div>
                    <div class="badge" style="background: rgba(231, 76, 60, 0.2); color: #c0392b;">Peggioramento</div>
                {% endif %}
            {% else %}
                <div class="value">-</div>
                <div class="badge">Nessun dato oggi</div>
            {% endif %}
        </div>

        <div class="widget">
            <span>ğŸ¯ Media Tiri / Match</span>
            <strong>{{ shot_metrics.avg_shots_per_match }}</strong>
            <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">
                Oggi: {{ shot_metrics.avg_shots_daily }}
            </div>
        </div>

        <div class="widget">
            <span>ğŸ¥µ Partita piÃ¹ Lunga</span>
            <strong>{{ shot_metrics.max_shots_match_hist }} Tiri</strong>
            <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">
                Oggi: {{ shot_metrics.max_shots_match_daily }}
            </div>
        </div>

        <div class="widget-insight-mini">
            <span class="label">ğŸ§‚ Trend Bordi (Oggi)</span>
            {% if comparison.played_today %}
                {% if comparison.delta_rim >= 0 %}
                    <div class="value" style="color: #3498db;">+{{ comparison.delta_rim }}%</div>
                    <div class="badge" style="background: rgba(52, 152, 219, 0.2); color: #2980b9;">PiÃ¹ Sfiga</div>
                {% else %}
                    <div class="value" style="color: #f39c12;">{{ comparison.delta_rim }}%</div>
                    <div class="badge" style="background: rgba(243, 156, 18, 0.2); color: #d35400;">Meno Sfiga</div>
                {% endif %}
            {% else %}
                <div class="value">-</div>
                <div class="badge">Nessun dato oggi</div>
            {% endif %}
        </div>

    </div> 
    
    <div class="stats-grid">
        <div class="chart-card">
            <h3>ğŸ“ Successo per Postazione</h3>
            <div class="chart-wrapper">
                <canvas id="chartPositionSuccess"></canvas>
            </div>
            <p class="chart-note">Da dove tiri meglio?</p>
        </div>

        <div class="chart-card">
            <h3>ğŸ¯ Successo per Postazione vs Bicchieri</h3>
            <div class="chart-wrapper">
                <canvas id="chartPosByCups"></canvas>
            </div>
            <p class="chart-note">Efficacia delle posizioni in base al numero di bicchieri avversari</p>
        </div>

        <div class="chart-card">
            <h3>ğŸ¥¤ Successo per Bevanda</h3>
            <div class="chart-wrapper">
                <canvas id="chartDrinkSuccess"></canvas>
            </div>
            <p class="chart-note">Quale bevanda ti rende piÃ¹ preciso?</p>
        </div>

        <div class="chart-card">
            <h3>âš–ï¸ Differenziale Bicchieri</h3>
            <div class="chart-wrapper">
                <canvas id="chartCupGap"></canvas>
            </div>
            <p class="chart-note">Verde (+): Vantaggio | Rosso (-): Svantaggio. Mostra la differenza dei bicchieri in campo in base numero di tiro</p>
        </div>

        <div class="chart-card">
            <h3>ğŸ¤ Win Rate per Compagno</h3>
            <div class="chart-wrapper">
                <canvas id="chartPartnerWinRate"></canvas>
            </div>
            <p class="chart-note">I compagni con cui vinci di piÃ¹</p>
        </div>

        <div class="chart-card">
            <h3>âš”ï¸ Loss Rate contro Avversario</h3>
            <div class="chart-wrapper">
                <canvas id="chartEnemyLossRate"></canvas>
            </div>
            <p class="chart-note">Gli avversari contro cui perdi di piÃ¹</p>
        </div>
    </div>

    <div class="chart-card" style="grid-column: 1 / -1; margin-top: 20px;">
        <h3>ğŸ“ˆ Efficacia per Numero Tiro</h3>
        <div class="chart-wrapper tall-chart">
            <canvas id="chartShotNumSuccess"></canvas>
        </div>
        <p class="chart-note">Precisione in base al numero di tiro nella partita</p>
    </div>

    <div class="bottom-widgets-container">
        <h2 class="section-title">ğŸ§ CuriositÃ </h2>
        <div class="insights-grid">
            
            
            <div class="widget-insight-mini">
                <span class="label">ğŸ“ Posizione Top</span>
                <div class="value">{{ insights.best_pos.split(' / ') | first }}</div>
                <div class="badge">{{ insights.best_pos_rate }}% Win</div>
            </div>

            <div class="widget-insight-mini">
                <span class="label">ğŸ¤ Partner Ideale</span>
                <div class="value">{{ insights.best_partner.split(' / ') | first }}</div>
                <div class="badge">{{ insights.best_partner_rate }}% Win</div>
            </div>

            <div class="widget-insight-mini danger">
                <span class="label">ğŸ’€ Da Evitare</span>
                <div class="value">{{ insights.worst_enemy.split(' / ') | first }}</div>
                <div class="badge">{{ insights.worst_enemy_rate }}% Loss</div>
            </div>

            <div class="widget-insight-mini">
                <span class="label">ğŸª„ Tiro Magico</span>
                <div class="value">{{ insights.best_shot_num.split(' / ') | first }}Â°</div>
                <div class="badge">{{ insights.best_shot_rate }}% Acc</div>
            </div>

            <div class="widget-insight-mini">
                <span class="label">ğŸ¹ Drink Boost</span>
                <div class="value">{{ insights.best_drink.split(' / ') | first }}</div>
                <div class="badge">{{ insights.best_drink_rate }}% Acc</div>
            </div>
            
            <div class="widget-insight-mini">
                <span class="label">ğŸ“… Giornata Migliore</span>
                <div class="value">{{ insights.best_day_date }}</div>
                <div class="badge">{{ insights.best_day_rate }}% Succ</div>
            </div>

            <div class="widget">
                <span>ğŸ§± Serie di Bordi piÃ¹ lunga</span>
                <strong>{{ streaks.rim_streak_hist }}</strong>
                <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">
                    Oggi: {{ streaks.rim_streak_daily }}
                </div>
            </div>

            <div class="widget">
                <span>ğŸ’¨ Serie di Miss piÃ¹ lunga</span>
                <strong>{{ streaks.miss_streak_hist }}</strong>
                <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">
                    Oggi: {{ streaks.miss_streak_daily }}
                </div>
            </div>

        </div>

        <h2 class="section-title" style="margin-top: 40px; color: #2ecc71;">ğŸ“ˆ Biggest Comeback</h2>
<div class="insights-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
    {% if comebacks and comebacks|length > 0 %}
        {% set top_cb = comebacks[0] %}
        <div class="widget-insight-mini" style="border-left: 4px solid #2ecc71;">
            <span class="label">ğŸ“… DATA</span>
            <div class="value">{{ top_cb.date }}</div>
        </div>
        <div class="widget-insight-mini" style="border-left: 4px solid #2ecc71;">
            <span class="label">ğŸ¤ COMPAGNO</span>
            <div class="value">{{ top_cb.teammate }}</div>
        </div>
        <div class="widget-insight-mini" style="border-left: 4px solid #2ecc71;">
            <span class="label">âš”ï¸ AVVERSARI</span>
            <div class="value" style="font-size: 0.85em;">{{ top_cb.opponent }}</div>
        </div>
        <div class="widget-insight-mini" style="border-left: 4px solid #2ecc71;">
            <span class="label">ğŸ“Š PEAK â†’ FINALE</span>
            <div class="value" style="color: #27ae60;">
                {{ top_cb.peak_score }} â†’ {{ top_cb.final_result }} ({{ top_cb.final_score }})
            </div>
        </div>
    {% else %}
        <div class="widget-insight-mini" style="grid-column: span 4; text-align: center;">
            <div class="value">Nessuna rimonta registrata</div>
        </div>
    {% endif %}
</div>

<h2 class="section-title" style="margin-top: 40px; color: #e74c3c;">ğŸ“‰ Biggest Flop</h2>
<div class="insights-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px;">
    {% if flops and flops|length > 0 %}
        {% set top_fl = flops[0] %}
        <div class="widget-insight-mini" style="border-left: 4px solid #e74c3c;">
            <span class="label">ğŸ“… DATA</span>
            <div class="value">{{ top_fl.date }}</div>
        </div>
        <div class="widget-insight-mini" style="border-left: 4px solid #e74c3c;">
            <span class="label">ğŸ¤ COMPAGNO</span>
            <div class="value">{{ top_fl.teammate }}</div>
        </div>
        <div class="widget-insight-mini" style="border-left: 4px solid #e74c3c;">
            <span class="label">âš”ï¸ AVVERSARI</span>
            <div class="value">{{ top_fl.opponent }}</div>
        </div>
        <div class="widget-insight-mini" style="border-left: 4px solid #e74c3c;">
            <span class="label">ğŸ“Š PEAK â†’ FINALE</span>
            <div class="value" style="color: #c0392b;">
                {{ top_fl.peak_score }} â†’ {{ top_fl.final_result }} ({{ top_fl.final_score }})
            </div>
        </div>
    {% else %}
        <div class="widget-insight-mini" style="grid-column: span 4; text-align: center;">
            <div class="value">Nessun flop registrato</div>
        </div>
    {% endif %}
</div>

<h2 class="section-title" style="margin-top: 40px; color: #f1c40f;">âš¡ï¸ Overtime âš¡ï¸</h2>
<div class="insights-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px;">
    {% if ot_metrics %}
        <div class="widget-insight-mini" style="border-left: 4px solid #f1c40f;">
            <span class="label">ğŸ† WINRATE OT</span>
            <div class="value">{{ ot_metrics.win_rate }}%</div>
            <div class="badge" style="background: rgba(241, 196, 15, 0.2); color: #9a7d0a;">
                Su {{ ot_metrics.total_matches }} partite
            </div>
        </div>

        <div class="widget-insight-mini" style="border-left: 4px solid #f1c40f;">
            <span class="label">ğŸ¯ ACCURACY OT</span>
            <div class="value">{{ ot_metrics.success_rate }}%</div>
            <div class="badge" style="background: rgba(241, 196, 15, 0.2); color: #9a7d0a;">Precisione tiri</div>
        </div>

        <div class="widget-insight-mini" style="border-left: 4px solid #f1c40f;">
            <span class="label">ğŸ•’ INIZIO MEDIO</span>
            <div class="value">{{ ot_metrics.avg_start_shot }}Â° Tiro</div>
            <div class="badge" style="background: rgba(241, 196, 15, 0.2); color: #9a7d0a;">Fase della partita</div>
        </div>

        <div class="widget-insight-mini" style="border-left: 4px solid #f1c40f;">
            <span class="label">â³ DURATA MEDIA</span>
            <div class="value">{{ ot_metrics.avg_duration }} Tiri</div>
            <div class="badge" style="background: rgba(241, 196, 15, 0.2); color: #9a7d0a;">Lunghezza extra</div>
        </div>
    {% else %}
        <div class="widget-insight-mini" style="grid-column: span 4; text-align: center;">
            <div class="value">Nessun Overtime giocato finora</div>
        </div>
    {% endif %}
</div>

    </div>

    {# --- MENU DI NAVIGAZIONE IN FONDO --- #}
    <div class="bottom-navigation">
        <div class="nav-buttons-container">
            <a href="{{ url_for('main.note_giocatore', player_name=player_name) }}" class="btn-nav extra">
                <i class="fas fa-sticky-note"></i>
                <span>Note & Tiri</span>
            </a>
            
            <a href="{{ url_for('main.grafici_formati') }}" class="btn-nav extra">
                <i class="fas fa-chart-pie"></i>
                <span>Analisi Formati</span>
            </a>

            <a href="{{ url_for('main.grafici_home') }}" class="btn-nav extra">
                <i class="fas fa-chart-line"></i>
                <span>Grafici Principali</span>
            </a>

            <a href="{{ url_for('main.home') }}" class="btn-nav extra btn-home-full">
                <i class="fas fa-home"></i>
                <span>Torna alla Home</span>
            </a>
        </div>
    </div>
</div> 
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <script>
        window.extraData = {
            rawStats: {{ stats_data | tojson }},
            partnerships: {{ partnerships | tojson }},
            shotMetrics: {{ shot_metrics | tojson }},
            posByCups: {{ pos_by_cups | tojson }}
        };
    </script>

    <script src="{{ url_for('static', filename='js/grafici/grafici_extra.js') }}"></script>
{% endblock %}